# ğŸ“ 2024.08.26 íšŒê³  ğŸ“
#### 1. ìˆ˜ì—… ë‚´ìš© ë³µìŠµì •ë¦¬
#### 2. ì˜¤ë¥˜ ìˆ˜ì •

---------------------------------
----------------------------------

# ì‡¼í•‘ ì¹´íŠ¸ ë° ì„¸ì…˜ ê´€ë¦¬
- ì˜¤ëŠ˜ì€ ì‡¼í•‘ ì¹´íŠ¸ ë° ì„¸ì…˜ ê´€ë¦¬ë¥¼ ì§„í–‰í•¨

### 1. ì„¸ì…˜(Session)
###### ì›¹ ë¸Œë¼ìš°ì €ë¥¼ í†µí•œ ì‚¬ìš©ìì˜ ìš”ì²­ì„ í•˜ë‚˜ì˜ ìƒíƒœë¡œ ìœ ì§€í•˜ëŠ” ê¸°ìˆ 
- ì„œë²„ì— ì •ë³´ë¥¼ ì €ì¥
- ë¸Œë¼ìš°ì €ë¥¼ ë‹«ê±°ë‚˜ ì„œë²„ì—ì„œ ì‚­ì œë  ë•Œ ì„¸ì…˜ ì¢…ë£Œ
- ì„¸ì…˜: ì„œë²„ ìì›ì„ ì‚¬ìš©
- ì¿ í‚¤: í´ë¼ì´ì–¸íŠ¸ ìì›ì„ ì‚¬ìš©
  
### 2. ì¥ê³  ì„¸ì…˜ í”„ë ˆì„ì›Œí¬
###### ì¥ê³ ì˜ ì„¸ì…˜ í”„ë ˆì„ì›Œí¬ëŠ” ìµëª… ë° ì‚¬ìš©ì ì„¸ì…˜ì„ ì§€ì›í•˜ê³ , ê° ë°©ë¬¸ìì˜ ë°ì´í„°ë¥¼ ì €ì¥
- request.sessionì„ ì‚¬ìš©í•˜ì—¬ ì„¸ì…˜ì— ì ‘ê·¼
- ì„¸ì…˜ ë°ì´í„°ëŠ” ë”•ì…”ë„ˆë¦¬ì²˜ëŸ¼ ì·¨ê¸‰
 
##### ì„¸ì…˜ ì„¤ì •
- SESSION_ENGINE: ì„¸ì…˜ ë°ì´í„° ì €ì¥ ìœ„ì¹˜ ì„¤ì •
- SESSION_COOKIE_AGE: ì„¸ì…˜ ì¿ í‚¤ ìœ íš¨ ê¸°ê°„ ì„¤ì •
- SESSION_EXPIRE_AT_BROWSER_CLOSE: ë¸Œë¼ìš°ì € ì¢…ë£Œ ì‹œ ì„¸ì…˜ ë§Œë£Œ ì—¬ë¶€ ì„¤ì •
- SESSION_SAVE_EVERY_REQUEST: ìš”ì²­ë§ˆë‹¤ ì„¸ì…˜ ì €ì¥ ì—¬ë¶€ ì„¤ì •

### 3. ì‡¼í•‘ ì¹´íŠ¸ êµ¬í˜„
##### 3.1 ì¹´íŠ¸ í´ë˜ìŠ¤
- `cart/cart.py` : ì¹´íŠ¸ ì´ˆê¸°í™”, ì•„ì´í…œ ì¶”ê°€, ì œê±° ë° ì¡°íšŒ ê¸°ëŠ¥ ì •ì˜
  
```
from decimal import Decimal
from django.conf import settings
from shop.models import Product

class Cart:
    def __init__(self, request):
        self.session = request.session
        cart = self.session.get(settings.CART_SESSION_ID)
        if not cart:
            cart = self.session[settings.CART_SESSION_ID] = {}
        self.cart = cart

    def add(self, product, quantity=1, override_quantity=False):
        product_id = str(product.id)
        if product_id not in self.cart:
            self.cart[product_id] = {'quantity': 0, 'price': str(product.price)}
        if override_quantity:
            self.cart[product_id]['quantity'] = quantity
        else:
            self.cart[product_id]['quantity'] += quantity
        self.save()

    def save(self):
        self.session.modified = True

    def remove(self, product):
        product_id = str(product.id)
        if product_id in self.cart:
            del self.cart[product_id]
            self.save()

    def __iter__(self):
        product_ids = self.cart.keys()
        products = Product.objects.filter(id__in=product_ids)
        cart = self.cart.copy()
        for product in products:
            cart[str(product.id)]['product'] = product
        for item in cart.values():
            item['price'] = Decimal(item['price'])
            item['total_price'] = item['price'] * item['quantity']
            yield item

    def __len__(self):
        return sum(item['quantity'] for item in self.cart.values())

    def get_total_price(self):
        return sum(Decimal(item['price']) * item['quantity'] for item in self.cart.values())

    def clear(self):
        del self.session[settings.CART_SESSION_ID]
        self.save()
```

### 3.2 ì¹´íŠ¸ ë·° ë° í¼
- `cart/views.py`, `cart/forms.py` : ì¹´íŠ¸ì— ì œí’ˆì„ ì¶”ê°€, ì œê±°í•˜ê³  ì¹´íŠ¸ ìƒì„¸ í˜ì´ì§€ë¥¼ ë Œë”ë§

###### ì¹´íŠ¸ ì¶”ê°€
```
@require_POST
def cart_add(request, product_id):
    cart = Cart(request)
    product = get_object_or_404(Product, id=product_id)
    form = CartAddProductForm(request.POST)
    if form.is_valid():
        cd = form.cleaned_data
        cart.add(product=product, quantity=cd['quantity'], override_quantity=cd['override'])
    return redirect('cart:cart_detail')
```

###### ì¹´íŠ¸ ì œê±°
```
@require_POST
def cart_remove(request, product_id):
    cart = Cart(request)
    product = get_object_or_404(Product, id=product_id)
    cart.remove(product)
    return redirect('cart:cart_detail')
```

###### ì¹´íŠ¸ ìƒì„¸
```
def cart_detail(request):
    cart = Cart(request)
    for item in cart:
        item['update_quantity_form'] = CartAddProductForm(initial={
                            'quantity': item['quantity'],
                            'override': True})
    return render(request, 'cart/detail.html', {'cart': cart})
```
### 3.3 ì½˜í…ìŠ¤íŠ¸ í”„ë¡œì„¸ì„œ
- `cart/context_processors.py` : ëª¨ë“  í…œí”Œë¦¿ì—ì„œ ì¹´íŠ¸ì— ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •

```
from .cart import Cart

def cart(request):
    return { 'cart': Cart(request) }
```

- ì„¤ì •
```
TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                'cart.context_processors.cart',
            ],
        },
    },
]
```

### 3.4 í…œí”Œë¦¿ ìˆ˜ì •
-  shop/templates/shop/product/detail.html : ì œí’ˆ ìƒì„¸ í˜ì´ì§€ì—ì„œ ì¹´íŠ¸ì— ì œí’ˆì„ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ í¼ì„ ì¶”ê°€

```
<form action="{% url 'cart:cart_add' product.id %}" method="post">
    {{ cart_product_form }}
    {% csrf_token %}
    <input type="submit" value="Add to cart">
</form>
```

- `cart/templates/cart/detail.html` : ì¹´íŠ¸ì˜ ë‚´ìš©ì„ í‘œì‹œí•˜ê³  ìˆ˜ëŸ‰ì„ ì—…ë°ì´íŠ¸í•  ìˆ˜ ìˆëŠ” í¼ì„ ì¶”ê°€
```
<table class="cart">
    <thead>
        <tr>
            <th>Image</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Remove</th>
            <th>Unit price</th>
            <th>Price</th>
        </tr>
    </thead>
    <tbody>
        {% for item in cart %}
            {% with product=item.product %}
                <tr>
                    <td>
                        <a href="{{ product.get_absolute_url }}">
                            <img src="{% if product.image %}{{ product.image.url }}{% else %}{% static 'img/no_image.png' %}{% endif %}">
                        </a>
                    </td>
                    <td>{{ product.name }}</td>
                    <td>
                        <form action="{% url 'cart:cart_add' product.id %}" method="post">
                            {{ item.update_quantity_form.quantity }}
                            {{ item.update_quantity_form.override }}
                            <input type="submit" value="Update">
                            {% csrf_token %}
                        </form>
                    </td>
                    <td>
                        <form action="{% url 'cart:cart_remove' product.id %}" method="post">
                            <input type="submit" value="Remove">
                            {% csrf_token %}
                        </form>
                    </td>
                    <td class="num">${{ item.price }}</td>
                    <td class="num">${{ item.total_price }}</td>
                </tr>
            {% endwith %}
        {% endfor %}
        <tr class="total">
            <td>Total</td>
            <td colspan="4"></td>
            <td class="num">${{ cart.get_total_price }}</td>
        </tr>
    </tbody>
</table>
```

### 4. ë³€ê²½ ì‚¬í•­ ì €ì¥ì„ ìœ„í•´ ì„œë²„ ì¬ì‹œì‘
```
python manage.py runserver
```


------------
---------------

# ì˜¤ë¥˜ ìˆ˜ì •
- ê¸°ì¡´ì˜ `cart/templates/cart/detail.html`ì—ì„œ ì•„ë˜ ë‚´ìš©ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ ê°€ê²©ë¶€ë¶„ì´ ë°€ë¦¬ëŠ” í˜„ìƒì´ ë²Œì–´ì§„ë‹¤. 
```
        <tr>
            <th>Image</th>
            <th>Product</th>
            <th>Quantity</th>
            <th>Remove</th>
            <th>Unit price</th>
            <th>Price</th>
        </tr>
```
![image](https://github.com/user-attachments/assets/e4a2d591-6c9c-48ef-bb68-24a2fb8a839c)

- í•˜ì§€ë§Œ ì´ê²ƒì€ ë°€ë¦¬ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, ìˆ«ìì˜ ê²½ìš° ë³´í†µ ìš°ì¸¡ì •ë ¬ì´ ê¸°ë³¸ baseë¡œ ì‘ë™í•´ì„œ ê·¸ëŸ° í˜„ìƒì´ ë²Œì–´ì§„ë‹¤ëŠ” ê²ƒì„ ê°•ì‚¬ë‹˜ì„ í†µí•´ì„œ ë“£ê²Œ ë˜ì—ˆë‹¤. í•˜ì—¬ Unit price, priceë¥¼ ì™¼ìª½ì •ë ¬í•´ì„œ ë§ì¶°ë³´ê¸°ë¡œ í–ˆë‹¤. (ê¸°ì¡´ì— ë°°ë„ˆì—ëŠ” ê¸€ë“¤ì´ ë‹¤ ì™¼ìª½ì •ë ¬ ë˜ì–´ìˆì—ˆê¸° ë•Œë¬¸)
- ë‹¤ë¥¸ê±´ ìˆ˜ì •í•  í•„ìš”ê°€ ì—†ì´ ì•„ë˜ ë‘ ë¶€ë¶„ì„ text-left ë¥¼ ì •ë ¬í•´ì£¼ë©´ ëœë‹¤.
```
        <th>Image</th>
        <th>Product</th>
        <th>Quantity</th>
        <th>Remove</th>
        <th class="text-left">Unit price</th>
        <th class="text-left">Price</th>
```
![image](https://github.com/user-attachments/assets/bc92cb34-23a3-43fc-97a4-ec2463615084)
