# ğŸ’  8ì›” 26ì¼ íšŒê³ 
## ğŸª ì˜¨ë¼ì¸ ìƒì  êµ¬ì¶• í”„ë¡œì íŠ¸ ğŸª
### ğŸ“ 2-2. ì‡¼í•‘ ì¹´íŠ¸ ë§Œë“¤ê¸°
### (3) ì„¸ì…˜ ì„¤ì •

- ì„¸ì…˜ ì„¤ì •
    - ì„¸ì…˜ êµ¬ì„±ì— ì‚¬ìš©ë˜ëŠ” ì„¤ì •
    - ê°€ì¥ ì¤‘ìš”í•œ ê²ƒì€ SESSION_ENGINE: ì„¸ì…˜ì´ ì €ì¥ë˜ëŠ” ìœ„ì¹˜ë¥¼ ì„¤ì •í•  ìˆ˜ ìˆìŒ
    - ì¥ê³ ì˜ ê¸°ë³¸ ì„¸ì…˜ ëª¨ë¸: django.contrib.sessions
    - ì¥ê³  ì„¸ì…˜ì˜ ì˜µì…˜
        - ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜: ê¸°ë³¸ ì„¸ì…˜ ì—”ì§„. ì„¸ì…˜ ë°ì´í„°ê°€ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë¨
        - íŒŒì¼ ê¸°ë°˜ ì„¸ì…˜
        - ìºì‹œê¸°ë°˜ ì„¸ì…˜
        - ìºì‹œ ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜
        - ì¿ í‚¤ ê¸°ë°˜ ì„¸ì…˜

- ì„¸ì…˜ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì„ ìœ„í•œ ì„¤ì •ë“¤
    - SESSION_COOKIE_AGE
        - ì„¸ì…˜ ì¿ í‚¤ì˜ ìœ íš¨ê¸°ê°„(ì´ˆ). ê¸°ë³¸ ê°’ì€ 1209600(2ì£¼ì¼)
    - SESSION_COOKIE_DOMAIN
        - ì„¸ì…˜ ì¿ í‚¤ì— ì‚¬ìš©ë˜ëŠ” ë„ë©”ì¸ (í•´ë‹¹í•˜ëŠ” ë„ë©”ì¸ì—ì„œë§Œ ë™ì‘í•˜ê²Œ í•¨)
            - í¬ë¡œìŠ¤ ë„ë©”ì¸ ì¿ í‚¤ ì‚¬ìš©: mydomain.comìœ¼ë¡œ ì„¤ì •
            - í‘œì¤€ ë„ë©”ì¸ ì¿ í‚¤ ì‚¬ìš©: Noneìœ¼ë¡œ ì„¤ì •
    - SESSION_COOKIE_HTTPONLY
        - ì„¸ì…˜ ì¿ í‚¤ì— HttpOnly í”Œë˜ê·¸ ì‚¬ìš© ì—¬ë¶€ ì§€ì •
        - Trueë¡œ ì„¤ì •í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ì˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì„¸ì…˜ ì¿ í‚¤ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ
        - ê¸°ë³¸ ê°’ì€ True: ì‚¬ìš©ì ì„¸ì…˜ íƒˆì·¨(Hijacking)ì— ëŒ€í•œ ë³´ì•ˆ ê°•í™” ëª©ì 
    - SESSION_COOKIE_SECURE
        - HTTPS ì—°ê²°ì¸ ê²½ìš°ì—ë§Œ ì¿ í‚¤ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŒ
        - ê¸°ë³¸ ê°’ì€ False
    - SESSION_EXPIRE_AT_BROWSER_CLOSE
        - ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì„ ë•Œ ì„¸ì…˜ì„ ë§Œë£Œí•´ì•¼ í•¨
        - ê¸°ë³¸ ê°’ì€ False
    - SESSION_SAVE_EVERY_REQUEST
        - Trueì¸ ê²½ìš°, ìš”ì²­í•  ë•Œë§ˆë‹¤ ì„¸ì…˜ì„ ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥
        - ì„¸ì…˜ì´ ì €ì¥ë  ë•Œë§ˆë‹¤ ì„¸ì…˜ ë§Œë£Œ ì‹œì ë„ ê°±ì‹ ë¨
        - ê¸°ë³¸ ê°’ì€ False
<br><br/>

### (4) ì„¸ì…˜ ë§Œë£Œ

- SESSION_EXPIRE_AT_BROWSER_CLOSE
    - ì„¤ì •ì˜ ì‚¬ìš©ìœ¼ë¡œ ë¸Œë¼ìš°ì € ê¸°ê°„ ì„¸ì…˜ ë˜ëŠ” ì˜êµ¬ ì„¸ì…˜ì˜ ì‚¬ìš©ì„ ì„¤ì •í•  ìˆ˜ ìˆìŒ
    - SESSION_COOKIE_AGE
    - ê¸°ë³¸ ê°’ì€ False
        - False: ì„¸ì…˜ ì§€ì† ì‹œê°„ì„ SESSION_COOKIE_AGEì— ì„¤ì •ëœ ê°’ìœ¼ë¡œ ê°•ì œ ì„¤ì •
        - True: ì‚¬ìš©ìê°€ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì„ ë•Œ ì„¸ì…˜ì´ ë§Œë£Œë˜ë©° SESSION_COOKIE_AGE ì„¤ì •ì€ ë¬´ì‹œë¨
- request.session.set_expiry() ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ ì„¸ì…˜ì˜ ê¸°ê°„ì„ ë®ì–´ì“¸ ìˆ˜ ìˆìŒ
<br><br/>

### (5) ì„¸ì…˜ì— ì‡¼í•‘ ì¹´íŠ¸ ì €ì¥í•˜ê¸°

- ì„¸ì…˜ì— ì¹´íŠ¸ ì•„ì´í…œë“¤ì„ ì €ì¥í•˜ë ¤ë©´ JSONìœ¼ë¡œ ì§ë ¬í™”í•  ìˆ˜ ìˆëŠ” ê°„ë‹¨í•œ êµ¬ì¡°ë¥¼ ë§Œë“¤ì–´ì•¼ í•¨
  
    1. ì¹´íŠ¸ì—ëŠ” ì¹´íŠ¸ì— í¬í•¨ëœ ê° í’ˆëª©ì— ëŒ€í•œ ë‹¤ìŒì˜ ë°ì´í„°ê°€ í¬í•¨ë˜ì–´ì•¼ í•¨
        - Product ì¸ìŠ¤í„´ìŠ¤ì˜ ID
        - ì„ íƒí•œ ì œí’ˆì˜ ìˆ˜ëŸ‰
        - ì œí’ˆì˜ ë‹¨ê°€
    2. ì‡¼í•‘ ì¹´íŠ¸ ìƒì„±
    3. ì‡¼í•‘ ì¹´íŠ¸ì™€ ì„¸ì…˜ì˜ ì—°ê²° ê¸°ëŠ¥ êµ¬ì¶•
        - ì¹´íŠ¸ê°€ í•„ìš”í•œ ê²½ìš° ì‚¬ìš©ìì˜ ì„¸ì…˜í‚¤ê°€ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ ì²´í¬
            - ì„¤ì •ëœ í‚¤ê°€ ì—†ì„ ê²½ìš° ìƒˆë¡œìš´ ì¹´íŠ¸ë¥¼ ìƒì„±í•˜ê³  ì¹´íŠ¸ ì„¸ì…˜ í‚¤ì— ì €ì¥
        - ì´í›„ ìš”ì²­ ì‹œ ë™ì¼í•œ í™•ì¸ì„ ìˆ˜í–‰í•´ì„œ ì¹´íŠ¸ ì„¸ì…˜ í‚¤ì—ì„œ ì¹´íŠ¸ ì•„ì´í…œë“¤ì„ ê°€ì ¸ì˜´
        - ì„¸ì…˜ì—ì„œ ì¹´íŠ¸ ì•„ì´í…œë“¤ì„ ì¡°íšŒ
        - ê´€ë ¨ Product ê°ì²´ë“¤ì„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì¡°íšŒ

- myshop/settings.py

  ```python
  CART_SESSION_ID = 'cart'
  ```

- Terminalì—ì„œ cartì•±ì„ ì„¤ì •

  ```python
  python manage.py startapp cart
  ```

- myshop/settings.py 

  ```python
  INSTALLED_APPS = [
    ...
    'shop.apps.ShopConfig',
    'cart.apps.CartConfig',
  ]
  ```

- cart/cart.py
    - ì¹´íŠ¸ ì´ˆê¸°í™”ë¥¼ ìœ„í•œ __ init__() ì •ì˜
    - ì¹´íŠ¸ì— ì•„ì´í…œì„ ì¶”ê°€í•˜ê¸° ìœ„í•œ add(), save() ì •ì˜
        - add()ì˜ ë§¤ê°œë³€ìˆ˜
            - product: ì¹´íŠ¸ì— ì¶”ê°€í•˜ê±°ë‚˜ ì—…ë°ì´íŠ¸í•  ì œí’ˆì˜ ì¸ìŠ¤í„´ìŠ¤
            - quantity: ì œí’ˆì˜ ìˆ˜ëŸ‰. ê¸°ë³¸ ê°’ì€ 1
            - override_quantity: ì§€ì •ëœ ìˆ˜ëŸ‰ìœ¼ë¡œ ìˆ˜ëŸ‰ì„ ì¬ì •ì˜í•´ì•¼ í•˜ëŠ”ì§€(True) ë˜ëŠ” ê¸°ì¡´ ìˆ˜ëŸ‰ì— ìƒˆë¡œìš´ ìˆ˜ëŸ‰ì„ ì¶”ê°€í•´ì•¼ í•˜ëŠ”ì§€(False)ë¥¼ ë‚˜íƒ€ë‚´ëŠ” Boolean ê°’
    - ì¹´íŠ¸ì˜ ì•„ì´í…œì„ ì œê±°í•˜ê¸° ìœ„í•œ remove() ì •ì˜
 <br><br/>
 
  ```python
  from decimal import Decimal
  from django.conf import settings
  from shop.models import Product

  class Cart:
      def __init__(self, request):
          self.session = request.session
          cart = self.session.get(settings.CART_SESSION_ID) #sessionì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ cartë¥¼ ìƒì„±
          if not cart:
              cart=self.session[settings.CART_SESSION_ID] = {} #ë¹„ì–´ì ¸ìˆëŠ” ë”•ì…”ë„ˆë¦¬ë¥¼ ë§Œë“¤ì–´ì„œ cartë¥¼ ë§Œë“¦
          self.cart = cart
  
      def add(self, product, quantity=1, override_quantity=False): #ì œí’ˆì— ëŒ€í•œ ì •ë³´ë¥¼ ë„£ëŠ”ë‹¤
          product_id = str(product.id) #prdouctê°€ ê°€ì§€ê³  ìˆëŠ” id í˜•íƒœê°€ intí˜•íƒœì¸ë° ì´ê±¸ strë¡œ ë°”ê¿”ì„œ ê°€ì§€ê³  ì˜´
          if product_id not in self.cart:
              self.cart[product_id] = {'quantity':0, 'price': str(product.price)}
          
          if override_quantity: #override_quantityê°€ Trueì¼ë•Œ ë®ì–´ì”Œìš´ë‹¤
              self.cart[product_id]['quantity']=quantity
          else: #override_quantityê°€ Falseì¼ë•Œ ì¶”ê°€í•´ì¤€ë‹¤
              self.cart[product_id]['quantity']+=quantity
          self.save()
  
      def save(self):
          self.session.modified = True
  
      def remove(self, product):
          product_id = str(product.id)
          if product_id in self.cart: #product_idê°€ ì €ì¥ë˜ì–´ ìˆëŠ” cartì†ì— ìˆë‹¤ë©´
              del self.cart[product_id]
              self.save()
  ```

- cart/cart.py
    - ì¹´íŠ¸ì— í¬í•¨ëœ ì•„ì´í…œë“¤ì„ ë°˜ë³µí•´ì„œ ê´€ë ¨ Product ì¸ìŠ¤í„´ìŠ¤ì— ì ‘ê·¼í•´ì•¼ í•¨. ì´ë¥¼ ìœ„í•´ì„œ __ iter__()ì •ì˜
    - ì¹´íŠ¸ì— í¬í•¨ëœ ì•„ì´í…œë“¤ì˜ ì´ ìˆ˜ë¥¼ ë°˜í™˜í•˜ê¸° ìœ„í•˜ì—¬ __ len__() ì •ì˜
    - ëª¨ë“  ì¹´íŠ¸ ì•„ì´í…œë“¤ì˜ ìˆ˜ëŸ‰ì˜ í•©ì„ ë°˜í™˜í•˜ê¸° ìœ„í•˜ì—¬ get_total_price() ì •ì˜
    - ì¹´íŠ¸ ì„¸ì…˜ì„ ì§€ìš°ê¸° ìœ„í•œ clear() ì •ì˜
<br><br/>

  ```python
    def __len__(self):
        return sum(item['quantity'] for item in self.cart.valuse())

    def __iter__(self):
        product_ids = self.cart.keys()
        products = Product.objects.filter(id__in=product_ids)
        cart = self.cart.copy()

        for product in products:
            cart[str(product.id)]['product'] = product
        
        for item in cart.values():
            item['price']=Decimal(item['price'])
            item['total_price']=item['price']*item['quantity']
            yield item
  
      def get_total_price(self):
        return sum(Decimal(item['price']) * item['quantity'] for item in self.cart.values())
    
      def clear(self):
          del self.session[settings.CART_SESSION_ID]
          self.save()
  ```
<br><br/>
### (6) ì¹´íŠ¸ ê´€ë ¨ ë·° ë§Œë“¤ê¸°

- cart/forms.py
    - ì¹´íŠ¸ì— ì•„ì´í…œ ì¶”ê°€í•˜ê¸°
<br><br/>
  ```python
  from django import forms

  PRODUCT_QUANTITY_CHOICES = [(i, str(i)) for i in range(1, 21)]
    
  class CartAddProductForm(forms.Form):
  quantity = forms.TypedChoiceField(choices=PRODUCT_QUANTITY_CHOICES, coerce=int)
  override = forms.BooleanField(required=False, initial=False, widget=forms.HiddenInput)
  ```

- cart/views.py

  ```python
    from django.shortcuts import render, get_object_or_404, redirect
    from django.views.decorators.http import require_POST
    from shop.models import Product
    from cart.cart import Cart
    from cart.forms import CartAddProductForm
    
    @require_POST
    def cart_add(request, product_id):
        cart = Cart(request)
        product = get_object_or_404(Product, id=product_id)
        form = CartAddProductForm(request.POST)
    
        if form.is_valid():
            cd = form.cleaned_data
            cart.add(product=product,
                     quantity=cd['quantity'],
                     override_quantity=cd['override'])
        return redirect('cart:cart_detail')
    
    
    @require_POST
    def cart_remove(request, product_id):
        cart = Cart(request)
        product = get_object_or_404(Product, id=product_id)
        cart.remove(product)
        return redirect('cart:cart_detail')
    
    
    def cart_detail(request):
        cart = Cart(request)
        for item in cart:
            item['update_quantity_form'] = CartAddProductForm(initial={
                'quantity': item['quantity'],
                'override': True})
        return render(request, 'cart/detail.html', {'cart':cart})
  ```

- cart/urls.py

  ```python
  from django.urls import path
  from cart import views
    
  app_name='cart'
    
  urlpatterns=[
      path('', views.cart_detail, name='cart_detail'),
      path('add/<int:product_id>/', views.cart_add, name='cart_add'),
      path('remove/<int:product_id>/', views.cart_remove, name='cart_remove'),
  ]
  ```

- cart/templates/cart/detail.html
    - ì¹´íŠ¸ë¥¼ í‘œì‹œí•˜ê¸° ìœ„í•œ í…œí”Œë¦¿ ì‘ì„±

  ```python
    {% extends "shop/base.html" %}
    {% load static %}
    
    {% block title %}
        Your shopping cart
    {% endblock %}
    
    {% block content %}
    <h1>Your shopping cart</h1>
    <table class="cart">
        <thead>
            <tr>
                <th>Image</th>
                <th>Product</th>
                <th>Quantity</th>
                <th>Remove</th>
                <th>Unit price</th> <!--ë‹¨ê°€-->
                <th>Price</th> <!--ë‹¨ê°€*quantity-->
            </tr>
        </thead>
        <tbody>
            {% for item in cart %}
                {% with product=item.product %}
                    <tr>
                        <td>
                            <a href="{{ product.get_absolute_url }}">
                                <img src="{% if product.image %}{{ product.image.url }}
                                            {% else %}{% static 'img/no_image.png' %}{% endif %}">
                            </a>
                        </td>
                        <td>{{ product.name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>
                            <form method="POST" action="{% url 'cart:cart_remove' product.id %}">
                                <input type="submit" value="Remove">
                                {% csrf_token %}
                            </form>
                        </td>
                        <td class="num">${{ item.price }}</td>
                        <td class="num">${{ item.total_price }}</td>
                    </tr>
                {% endwith %}
            {% endfor %}
            <tr class="total">
                <td>Total</td>
                <td colspan="4"></td>
                <td class="num">${{ cart.get_total_price }}</td>
            </tr>
        </tbody>
    </table>
    <p class="text-right">
        <a href="{% url 'shop:product_list' %}" class="button light">Continue shopping</a>
        <a href="#" class="button">Checkout</a>
    </p>
    {% endblock %}  
  ```

























