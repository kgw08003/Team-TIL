# ğŸ“ 2024.08.27 íšŒê³  ğŸ“
#### 1. ìˆ˜ì—… ë‚´ìš© ë³µìŠµì •ë¦¬
#### 2. ì˜¤ë¥˜

---------------------------------

# Django í”„ë¡œì íŠ¸ì—ì„œ ê³ ê° ì£¼ë¬¸ ì²˜ë¦¬ ë° ë¹„ë™ê¸° ì‘ì—… ì²˜ë¦¬ ìš”ì•½
### 1. ê³ ê° ì£¼ë¬¸ ë“±ë¡ ë° ê´€ë¦¬
#### 1.1. ì•± ìƒì„± ë° ì„¤ì •

- orders ì•± ìƒì„±: python manage.py startapp orders
- settings.pyì—ì„œ INSTALLED_APPSì— orders ì•± ì¶”ê°€:

```
INSTALLED_APPS = [
    ...
    'shop.apps.ShopConfig',
    'cart.apps.CartConfig',
    'orders.apps.OrdersConfig',
]
```

### 1.2. ì£¼ë¬¸ ëª¨ë¸ ìƒì„±

- Orderì™€ OrderItem ëª¨ë¸ ìƒì„± (orders/models.py)

```
from django.db import models
from shop.models import Product

class Order(models.Model):
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    email = models.EmailField()
    address = models.CharField(max_length=250)
    postal_code = models.CharField(max_length=20)
    city = models.CharField(max_length=100)
    created = models.DateTimeField(auto_now_add=True)
    updated = models.DateTimeField(auto_now=True)
    paid = models.BooleanField(default=False)

    class Meta:
        ordering = ['-created']
        indexes = [models.Index(fields=['-created']),]

    def __str__(self):
        return f'Order {self.id}'

    def get_total_cost(self):
        return sum(item.get_cost() for item in self.items.all())

class OrderItem(models.Model):
    order = models.ForeignKey(Order, related_name='items', on_delete=models.CASCADE)
    product = models.ForeignKey(Product, related_name='order_items', on_delete=models.CASCADE)
    price = models.DecimalField(max_digits=10, decimal_places=2)
    quantity = models.PositiveIntegerField(default=1)

    def __str__(self):
        return str(self.id)

    def get_cost(self):
        return self.price * self.quantity
```
- ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ë° ì ìš©

```
python manage.py makemigrations
python manage.py migrate
```

### 1.3. ì£¼ë¬¸ ëª¨ë¸ ê´€ë¦¬ ì‚¬ì´íŠ¸ì— ì¶”ê°€

- orders/admin.pyì—ì„œ Orderì™€ OrderItemì„ ê´€ë¦¬ í˜ì´ì§€ì— ë“±ë¡:

```
from django.contrib import admin
from .models import Order, OrderItem

class OrderItemInline(admin.TabularInline):
    model = OrderItem
    raw_id_fields = ['product']

@admin.register(Order)
class OrderAdmin(admin.ModelAdmin):
    list_display = ['id', 'first_name', 'last_name', 'email', 'address', 'postal_code', 'city', 'paid', 'created', 'updated']
    list_filter = ['paid', 'created', 'updated']
    inlines = [OrderItemInline]
```
### 1.4. ì£¼ë¬¸ ìƒì„± ë·°ì™€ í¼

- orders/forms.pyì— ì£¼ë¬¸ ìƒì„± í¼ ì¶”ê°€:

```
from django import forms
from .models import Order

class OrderCreateForm(forms.ModelForm):
    class Meta:
        model = Order
        fields = ['first_name', 'last_name', 'email', 'address', 'postal_code', 'city']
```

- orders/views.pyì— ì£¼ë¬¸ ìƒì„± ë¡œì§ ì¶”ê°€:
```
from django.shortcuts import render
from .models import OrderItem
from .forms import OrderCreateForm
from cart.cart import Cart

def order_create(request):
    cart = Cart(request)
    if request.method == 'POST':
        form = OrderCreateForm(request.POST)
        if form.is_valid():
            order = form.save()
            for item in cart:
                OrderItem.objects.create(order=order, product=item['product'], price=item['price'], quantity=item['quantity'])
            cart.clear()
            return render(request, 'orders/order/created.html', {'order': order})
    else:
        form = OrderCreateForm()
    return render(request, 'orders/order/create.html', {'cart': cart, 'form': form})
```
### 1.5. URL ì„¤ì • ë° í…œí”Œë¦¿ êµ¬ì„±

- orders/urls.pyì—ì„œ ì£¼ë¬¸ ìƒì„± ë·°ì˜ URL íŒ¨í„´ ì¶”ê°€:

```
from django.urls import path
from . import views

app_name = 'orders'

urlpatterns = [
    path('create/', views.order_create, name='order_create'),
]
```
myshop/urls.pyì— orders URL ì„¤ì • ì¶”ê°€:

```
urlpatterns = [
    path('admin/', admin.site.urls),
    path('cart/', include('cart.urls', namespace='cart')),
    path('orders/', include('orders.urls', namespace='orders')),
    path('', include('shop.urls', namespace='shop')),
]
```

cart/templates/cart/detail.htmlì—ì„œ Checkout ë²„íŠ¼ URL ìˆ˜ì •:

```
<a href="{% url 'orders:order_create' %}" class="button">Checkout</a>
```

## 2. ì„±ëŠ¥ ê°œì„  - ë¹„ë™ê¸° ì‘ì—… ì²˜ë¦¬
### 2.1. ë¹„ë™ê¸° ì‘ì—… ì²˜ë¦¬ ê°œë…

- ë™ê¸°: íƒœìŠ¤í¬ë¥¼ ì§ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬, ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ë°›ì•„ì•¼ ë‹¤ìŒ ì‘ì—…ì´ ì‹¤í–‰.
- ë¹„ë™ê¸°: íƒœìŠ¤í¬ë¥¼ ë³‘ë ¬ì ìœ¼ë¡œ ì²˜ë¦¬, ì‘ë‹µ ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ ë‹¤ìŒ ì‘ì—… ì‹¤í–‰.
### 2.2. Celeryì™€ RabbitMQë¥¼ ì´ìš©í•œ ë¹„ë™ê¸° ì‘ì—…

- Celery: ë¶„ì‚° ì‘ì—… íë¡œ, ë¹„ë™ê¸° ì‘ì—…ì„ ìƒì„±í•˜ê³  ì²˜ë¦¬ ê°€ëŠ¥.
- RabbitMQ: Celeryì™€ í•¨ê»˜ ì‚¬ìš©í•˜ëŠ” ë©”ì‹œì§€ ë¸Œë¡œì»¤, ë©”ì‹œì§€ íë¥¼ í†µí•´ ì‘ì—…ì„ ë¶„ì‚° ì²˜ë¦¬.

### 2.3. Celery ì„¤ì • ë° ì‘ì—… ì¶”ê°€

- Celery ì„¤ì¹˜:
```
pip install celery
```

- RabbitMQ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰:
```
docker pull rabbitmq
docker run -it --rm --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:management
```
- myshop/celery.pyì— Celery ì„¤ì •:
```
import os
from celery import Celery

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'myshop.settings')

app = Celery('myshop')
app.config_from_object('django.conf:settings', namespace='CELERY')
app.autodiscover_tasks()
```

- myshop/__init__.pyì—ì„œ Celery ë¡œë“œ ì„¤ì •:
```
from .celery import app as celery_app

__all__ = ['celery_app']
```

- Celery ì›Œì»¤ ì‹¤í–‰:
```
celery -A myshop worker -l info
```
### 2.4. ë¹„ë™ê¸° ì‘ì—… ì¶”ê°€

- ì£¼ë¬¸ì´ ì ‘ìˆ˜ë˜ë©´ ë¹„ë™ê¸°ì ìœ¼ë¡œ í™•ì¸ ì´ë©”ì¼ì„ ë³´ë‚´ê¸° ìœ„í•´ orders/tasks.pyì— ì‘ì—… ì¶”ê°€:

```
from celery import shared_task
from django.core.mail import send_mail
from .models import Order

@shared_task
def order_created(order_id):
    order = Order.objects.get(id=order_id)
    subject = f'Order nr. {order.id}'
    message = f'Dear {order.first_name},\n\nYou have successfully placed an order. Your order ID is {order.id}.'
    mail_sent = send_mail(subject, message, 'admin@myshop.com', [order.email])
    return mail_sent
```

- ì£¼ë¬¸ ìƒì„± ì‹œ ì´ë©”ì¼ ì „ì†¡ì„ ë¹„ë™ê¸° ì‘ì—…ìœ¼ë¡œ ì²˜ë¦¬ (orders/views.py):
```
from orders.tasks import order_created

def order_create(request):
    ...
    if request.method == "POST":
        ...
        if form.is_valid():
            ...
            cart.clear()
            order_created.delay(order.id)
            ...
```
### 3. ì´ë©”ì¼ ì „ì†¡ì„ ìœ„í•œ SMTP ì„¤ì •
- SMTP ì„¤ì •ì„ í†µí•´ ì´ë©”ì¼ ì „ì†¡ (myshop/settings.py):
```
EMAIL_HOST = "smtp.gmail.com"
EMAIL_PORT = 587
EMAIL_HOST_USER = "user_account@gmail.com"
EMAIL_HOST_PASSWORD = "****"
EMAIL_USE_TLS = True
```
- í…ŒìŠ¤íŠ¸ ì‹œ ì½˜ì†”ë¡œ ì´ë©”ì¼ ì¶œë ¥ ì„¤ì •:
```
EMAIL_BACKEND = "django.core.mail.backends.console.EmailBackend"

```

- ë„ì»¤ ì‹¤í–‰í•˜ê³  í•´ë‹¹ ì£¼ì†Œë¡œ ë“¤ì–´ê°„ ì‚¬ì§„
![docker](https://github.com/user-attachments/assets/dbc66fb8-30b3-4f14-b773-44cb9b23ad7f)

## ì˜¤ë¥˜
- ì¥ë°”êµ¬ë‹ˆì—ì„œ ì£¼ë¬¸ ë„˜ê¸°ëŠ”ê²ƒ ê¹Œì§€ëŠ” ì •ìƒ ì‘ë™ì„ í•˜ëŠ”ë°, ë„˜ê¸°ê³  ë‚˜ì„œ ë©”ì¼ or ì›¹ ìƒìœ¼ë¡œ ì£¼ë¬¸ ë‚´ìš©ì´ ë³´ë‚´ì ¸ì•¼ í•˜ëŠ”ë° ì•„ë˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ëœ¨ë©´ì„œ ë™ì‘í•˜ì§€ ì•ŠìŒ

```
Did you remember to import the module containing this task?
Or maybe you're using relative imports?

Please see
https://docs.celeryq.dev/en/latest/internals/protocol.html
for more information.

The full contents of the message body was:
'[[3], {}, {"callbacks": null, "errbacks": null, "chain": null, "chord": null}]' (78b)

The full contents of the message headers:
{'argsrepr': '(3,)', 'eta': None, 'expires': None, 'group': None, 'group_index': None, 'id': '132a88fc-5892-4ad8-ad40-d194a07fcc80', 'ignore_result': False, 'kwargsrepr': '{}', 'lang': 'py', 'origin': 'gen8376@DESKTOP-457G2CN', 'parent_id': None, 'replaced_task_nesting': 0, 'retries': 0, 'root_id': '132a88fc-5892-4ad8-ad40-d194a07fcc80', 'shadow': None, 'stamped_headers': None, 'stamps': {}, 'task': 'orders.tasks.order_created', 'timelimit': [None, None]}

The delivery info for this task is:
{'consumer_tag': 'None4', 'delivery_tag': 1, 'redelivered': False, 'exchange': '', 'routing_key': 'celery'}
Traceback (most recent call last):
  File "C:\workspace\myshop\Lib\site-packages\celery\worker\consumer\consumer.py", line 659, in on_task_received
    strategy = strategies[type_]
               ~~~~~~~~~~^^^^^^^
KeyError: 'orders.tasks.order_created'
```

